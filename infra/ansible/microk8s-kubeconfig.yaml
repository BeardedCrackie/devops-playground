- hosts: microk8s
  become: true

  tasks:
    - name: Generate kubeconfig from microk8s
      command: microk8s config
      register: kubeconfig_output

    - name: Save kubeconfig to file on remote
      copy:
        content: "{{ kubeconfig_output.stdout }}"
        dest: "/home/{{ ansible_user }}/.kube/config"
        mode: '0600'

    - name: Copy kubeconfig to local machine
      become: false
      local_action: copy content="{{ kubeconfig_output.stdout }}" dest="../terraform/kubeconfig"
      delegate_to: localhost

    - name: Add alias kubectl to .bashrc
      lineinfile:
        path: "/home/{{ ansible_user }}/.bashrc"
        line: 'alias kubectl="microk8s kubectl"'
        create: yes  # Create the file if it doesn't exist
        state: present  # Ensure the line is present
